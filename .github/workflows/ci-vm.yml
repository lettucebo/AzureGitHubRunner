name: CI - Terraform VM Runner Infrastructure

# =============================================================================
# æ­¤ workflow ç”¨æ–¼é©—è­‰ TERRAFORM è³‡æ–™å¤¾ä¸­çš„ VM Self-Hosted Runner åŸºç¤è¨­æ–½
# ä½¿ç”¨ VM ä¸Šçš„ Self-Hosted Runner åŸ·è¡Œ
# =============================================================================

on:
  push:
    branches: [main]
    paths:
      - 'TERRAFORM/**'
      - 'scripts/**'
      - '.github/workflows/ci-vm.yml'
  pull_request:
    branches: [main]
    paths:
      - 'TERRAFORM/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  # ============================================
  # Terraform é©—è­‰
  # ============================================
  validate-terraform:
    name: Validate Terraform
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show Terraform Version
        run: terraform version
      
      - name: Terraform Format Check
        run: |
          echo "ğŸ” Checking Terraform format..."
          cd TERRAFORM
          terraform fmt -check -recursive
          echo "âœ… Format check passed"
      
      - name: Terraform Init
        run: |
          echo "ğŸ” Initializing Terraform..."
          cd TERRAFORM
          terraform init -backend=false
          echo "âœ… Terraform initialized"
      
      - name: Terraform Validate
        run: |
          echo "ğŸ” Validating Terraform configuration..."
          cd TERRAFORM
          terraform validate
          echo "âœ… Terraform validation passed"

  # ============================================
  # Shell Script é©—è­‰
  # ============================================
  validate-scripts:
    name: Validate Shell Scripts
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check TERRAFORM Scripts
        run: |
          echo "ğŸ” Checking TERRAFORM shell scripts..."
          if command -v shellcheck &> /dev/null; then
            shellcheck TERRAFORM/scripts/*.sh || true
          else
            echo "âš ï¸ shellcheck not installed, skipping"
          fi
          echo "âœ… Shell script check completed"
      
      - name: Check Root Scripts
        run: |
          echo "ğŸ” Checking root scripts..."
          if command -v shellcheck &> /dev/null; then
            shellcheck scripts/*.sh 2>/dev/null || true
          fi
          echo "âœ… Root script check completed"

  # ============================================
  # YAML é©—è­‰ (cloud-init)
  # ============================================
  validate-yaml:
    name: Validate Cloud-Init YAML
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Cloud-Init YAML
        run: |
          echo "ğŸ” Checking cloud-init configuration..."
          if command -v yamllint &> /dev/null; then
            yamllint -d relaxed TERRAFORM/scripts/cloud-init.yml || true
          else
            echo "âš ï¸ yamllint not installed, basic syntax check..."
            python3 -c "import yaml; yaml.safe_load(open('TERRAFORM/scripts/cloud-init.yml'))" && echo "âœ… YAML syntax valid"
          fi

  # ============================================
  # çµæœæ‘˜è¦
  # ============================================
  summary:
    name: Validation Summary
    runs-on: self-hosted
    needs: [validate-terraform, validate-scripts, validate-yaml]
    if: always()
    
    steps:
      - name: Check Results
        run: |
          echo "========================================"
          echo "ğŸ“‹ Terraform VM Runner - Validation Summary"
          echo "========================================"
          echo "Terraform: ${{ needs.validate-terraform.result }}"
          echo "Scripts:   ${{ needs.validate-scripts.result }}"
          echo "YAML:      ${{ needs.validate-yaml.result }}"
          echo "========================================"
          
          if [[ "${{ needs.validate-terraform.result }}" == "failure" ]]; then
            echo "âŒ Terraform validation failed"
            exit 1
          fi
          
          echo "âœ… All validations passed!"
