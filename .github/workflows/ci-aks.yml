name: CI - Bicep AKS Coding Agent Infrastructure

# =============================================================================
# æ­¤ workflow ç”¨æ–¼é©—è­‰ BICEP è³‡æ–™å¤¾ä¸­çš„ AKS + ARC åŸºç¤è¨­æ–½
# æ”¯æ´ GitHub Copilot Coding Agent
# ä½¿ç”¨ AKS ä¸Šçš„ ARC Self-Hosted Runner åŸ·è¡Œ
# =============================================================================

on:
  push:
    branches: [main]
    paths:
      - 'src/aks-runner/**'
      - '.github/workflows/ci-aks.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/aks-runner/**'
  workflow_dispatch:

jobs:
  # ============================================
  # Bicep é©—è­‰
  # ============================================
  validate-bicep:
    name: Validate Bicep
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Azure CLI and Bicep
        run: |
          # Azure CLI is pre-installed on ubuntu-latest
          az version
          az bicep install
          az bicep version
      
      - name: Bicep Build (Syntax Check)
        run: |
          echo "ğŸ” Validating Bicep syntax..."
          az bicep build --file src/aks-runner/main.bicep --stdout > /dev/null
          echo "âœ… Bicep syntax is valid"
      
      - name: Bicep Lint (Best Practices)
        run: |
          echo "ğŸ” Running Bicep linter..."
          az bicep lint --file src/aks-runner/main.bicep
          echo "âœ… Bicep linting passed"

  # ============================================
  # Shell Script é©—è­‰
  # ============================================
  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Check Shell Scripts
        run: |
          echo "ğŸ” Checking shell scripts..."
          shellcheck src/aks-runner/scripts/*.sh || true
          echo "âœ… Shell script check completed"

  # ============================================
  # YAML é©—è­‰
  # ============================================
  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install yamllint
        run: |
          pip install yamllint
      
      - name: Lint Kubernetes YAML
        run: |
          echo "ğŸ” Checking Kubernetes manifests..."
          yamllint -d relaxed src/aks-runner/kubernetes/*.yaml || true
          echo "âœ… YAML check completed"

  # ============================================
  # çµæœæ‘˜è¦
  # ============================================
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-bicep, validate-scripts, validate-yaml]
    if: always()
    
    steps:
      - name: Check Results
        run: |
          echo "========================================"
          echo "ğŸ“‹ Bicep AKS Coding Agent - Validation Summary"
          echo "========================================"
          echo "Bicep:   ${{ needs.validate-bicep.result }}"
          echo "Scripts: ${{ needs.validate-scripts.result }}"
          echo "YAML:    ${{ needs.validate-yaml.result }}"
          echo "========================================"
          
          if [[ "${{ needs.validate-bicep.result }}" == "failure" ]]; then
            echo "âŒ Bicep validation failed"
            exit 1
          fi
          
          echo "âœ… All validations passed!"
